name: Security CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  security-scan:
    name: Go Security Scanning
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.20'

    - name: Install Gosec binary and Semgrep
      run: |
        # Install Gosec binary
        curl -Lo gosec.tar.gz https://github.com/securego/gosec/releases/download/v2.22.7/gosec_2.22.7_linux_amd64.tar.gz
        tar -xzf gosec.tar.gz
        sudo mv gosec /usr/local/bin/
        
        # Install Semgrep
        pip install semgrep

    - name: Download Go modules
      working-directory: ./go_app_backend
      run: go mod download

    - name: Run Gosec (fail on findings)
      working-directory: ./go_app_backend
      run: |
        gosec -severity medium -fmt sarif -out ../gosec.sarif ./...

    - name: Run Semgrep (fail on findings)
      run: |
        semgrep --config=auto --sarif --output=semgrep.sarif

    - name: Install Trivy
      run: |
        curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin

    - name: Build Docker Image
      run: docker build -t myapp:latest ./go_app_backend

    - name: Run Trivy Image Scan (fail on HIGH or CRITICAL)
      run: |
        trivy image --exit-code 1 --severity HIGH,CRITICAL --format sarif --output trivy.sarif myapp:latest

    - name: Upload Gosec results
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: gosec.sarif

    - name: Upload Semgrep results
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: semgrep.sarif

    - name: Upload Trivy results
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: trivy.sarif
