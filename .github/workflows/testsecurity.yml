name: Security CI/CD

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest

    steps:
    - name: 🧾 Checkout code
      uses: actions/checkout@v3

    - name: 🧰 Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: 📦 Install Semgrep & Trivy
      run: |
        pip install semgrep
        sudo apt-get update
        sudo apt-get install wget apt-transport-https gnupg lsb-release -y
        wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
        echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | sudo tee -a /etc/apt/sources.list.d/trivy.list
        sudo apt-get update
        sudo apt-get install trivy -y
        sudo apt-get install jq -y

    - name: 🔍 Run Semgrep (SAST)
      run: |
        semgrep --config "p/owasp-top-ten" \
          --sarif --output semgrep.sarif

    - name: 🐳 Build Docker Image
      run: |
        docker build -t myapp:latest ./go_app_backend

    - name: 🐳 Run Trivy (Container Scan)
      run: |
        trivy image --severity HIGH,CRITICAL \
          --format sarif --output trivy.sarif myapp:latest

    - name: 📊 Check SARIF for High Severity Issues
      run: |
        check_sarif() {
          local file=$1
          local count=$(jq '[.runs[].results[] | select(.level=="error" or .level=="warning")] | length' "$file")
          echo "Found $count high/critical issues in $file"
          if [ "$count" -gt 0 ]; then
            echo "❌ Blocking build due to high severity issues."
            exit 1
          fi
        }

        check_sarif semgrep.sarif
        check_sarif trivy.sarif

    - name: 📤 Upload Semgrep SARIF
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: semgrep.sarif

    - name: 📤 Upload Trivy SARIF
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: trivy.sarif
